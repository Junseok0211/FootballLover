{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'match/css/comment.css' %}" />
<style>
  /*전체디자인*/
  .commentDesign{
    padding:0.5rem;
    max-width: 720px;
    margin: 0 auto;
  }

  /*댓글 작성 관련*/
  .commentBox{
    display: flex;
    flex-direction: row;
  }

  .commentBox textarea{
    font-family: 'Nanum Gothic';
    box-sizing:border-box;
    font-size:15px;
    color:#333;
    border-top: none;
    border-left: none;
    border-right: none;
    margin-left: 10px;
    width: 97%;
    outline: none;
    background:none;
    height:30px;
    resize:none;
    overflow-y:hidden;
  }

  .commentBox textarea:focus{
    border-bottom: 2px solid black;
    transition:.5s;
  }
  /*댓글 작성 관련 끝 */

  /* 댓글 수정 관련 */    
  .commentEditBox{
    display: flex;
    flex-direction: row;
    max-width: 720px;
    width: 100%;
  }

  .commentEditBox textarea{
    font-family: 'Nanum Gothic';
    box-sizing:border-box;
    font-size:15px;
    color:#333;
    border-top: none;
    border-left: none;
    border-right: none;
    margin-left: 10px;
    width: 97%;
    outline: none;
    background:none;
    height:30px;
    resize:none;
    overflow-y:hidden;
  }

  .commentEditBox textarea:focus{
    border-bottom: 2px solid black;
    transition:.5s;
  }


  .editForm{
    display: none;
  }

  .editToggle > .editForm{
    display: block;
  }

  .editToggle > .detail{
    display:none;
  }
  /*댓글 수정 관련 끝 */

  /*답글 입력 관련*/
  .replyBox{
    display: flex;
    flex-direction: row;
    max-width: 720px;
    width: 100%;
  }

  .replyBox textarea{
    font-family: 'Nanum Gothic';
    box-sizing:border-box;
    font-size:15px;
    color:#333;
    border-top: none;
    border-left: none;
    border-right: none;
    width: 97%;
    outline: none;
    background:none;
    margin-left: 10px;
    height:30px;
    resize:none;
    overflow-y:hidden;
  }

  .replyBox textarea:focus{
    border-bottom: 2px solid black;
    transition:.5s;
  }
  /* 답글 입력 관련 끝 */

  /* 답글 수정 관련 */
  .replyEditBox{
    display: flex;
    flex-direction: row;
    max-width: 720px;
    width: 100%;
  }

  .replyEditText textarea{
    font-family: 'Nanum Gothic';
    box-sizing:border-box;
    font-size:15px;
    color:#333;
    border-top: none;
    border-left: none;
    border-right: none;
    width: 97%;
    outline: none;
    background:none;
    margin-left: 10px;
    height:30px;
    resize:none;
    overflow-y:hidden;
  }

  .replyEditText textarea:focus{
    border-bottom: 2px solid black;
    transition:.5s;
  }

  .replyEditToggle > .replyEditForm{
    display:block;
  }  

  .replyEditToggle > .replyDetail{
    display:none;
  }   

  /*답글 수정 관련 끝 */

  /* 답글 상세 관련 */
  .replyDetail{
    display: flex;
    flex-direction: row;
    max-width: 720px;
    width:100%
  }
  /* 답글 상세 관련 끝 */

  /* 답글 버튼 관련 */    
  /* 대댓글 창 먼저 안나오게 하기! */
  .replyAll{
    display:none;
  }
  
  .replyEditForm{
    display: none;
  }
    
  /* 답글 눌렀을 때 */
  .replyToggle{
    display:block;
  }

  .allReplyCancel{
    display:none;
  }

  .replyButton > .reply{
    display:none;
  }

  .replyButton > .allReplyCancel{
    display:block;
  }
  /* 답글 버튼 관련 끝 */    

  /*등록 취소 수정 버튼 관련*/ 
  .commentBtnWrapper{
    display: flex; 
    justify-content: flex-end; 
    margin-bottom: 5px;
  }
  .commentBtn{
    font-family: 'Nanum Gothic';
    width:70px;
    height:40px;
    border:none; 
    background-color: gray;
    color:#fff;
    outline:none;
    cursor: pointer;
  }
  /*등록 취소 수정 버튼 관련 끝*/ 

  /*상세 댓글 관련*/ 
  .detail{
    display: flex;
    flex-direction: row;
  }

  .comment{
    padding-left: 10px;
    width: 92%;
    padding-right: 10px;
    
  }

  .commentImg{
    width: 5%; 
    margin-right: 0.3rem;
  }

  .commentText{
    width: 95%;
  }

  .commentName{
    font-weight: bold;
    font-size: 12px;
    font-family: 'Nanum Gothic';
  }

  .commentTime{
    font-size: 13px;
    font-family: 'Nanum Gothic';
    color: gray;
  }

  .commentContent{
    font-size: 14px;
    font-family: 'Nanum Gothic';
    white-space: pre-line;
    word-wrap: break-word;
    width: auto;
  }
  /*상세 댓글 끝*/ 

  /* 댓글 메뉴버튼 */
  .commentDropBtn {
    border:none; 
    background-color: white;
    font-size: 16px;
    cursor: pointer;
  }

  .commentDropDown {
    position: relative;
    display: inline-block;
  }

  .cmDropDownContent {
    display: none;
    position: absolute;
    right: 0;
    background-color: #f9f9f9;
    font-size: 15px;
    min-width: 100px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    text-align: center;
  }

  .cmDropDownContent a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }

  .dropdown-item:hover {background-color: darkgray;}

  .commentDropDown:hover .cmDropDownContent {
      display: block;
  }

  .commentDropDown i{
    color:gray;
  }

  /*자세히 보기 관련 */
  .commentDetail{
    display: none;
  }

  .commentDetailView{
    color: black;
  }

  .detailedText > .commentDetail{
    display:block;
  }

  .detailedText > .summary{
    display:none;
  }
  /*자세히 보기 관련 끝 */

  @media screen and (max-width: 500px){
    .comment{
      padding-left: 10px;
      width: 84%;
      padding-right: 10px;
      
    }

    .commentBox textarea{
      font-family: 'Nanum Gothic';
      box-sizing:border-box;
      font-size:13px;
      color:#333;
      border-top: none;
      border-left: none;
      border-right: none;
      width: 97%;
      outline: none;
      background:none;
      height:30px;
      resize:none;
      overflow-y:hidden;
    }

    .commentEditBox textarea{
      font-family: 'Nanum Gothic';
      box-sizing:border-box;
      font-size:13px;
      color:#333;
      border-top: none;
      border-left: none;
      border-right: none;
      width: 97%;
      outline: none;
      background:none;
      height:30px;
      resize:none;
      overflow-y:hidden;
    }

    .replyBox textarea{
      font-family: 'Nanum Gothic';
      box-sizing:border-box;
      font-size:13px;
      color:#333;
      border-top: none;
      border-left: none;
      border-right: none;
      width: 97%;
      outline: none;
      background:none;
      height:30px;
      resize:none;
      overflow-y:hidden;
    }

    .replyEditText textarea{
      font-family: 'Nanum Gothic';
      box-sizing:border-box;
      font-size:13px;
      color:#333;
      border-top: none;
      border-left: none;
      border-right: none;
      width: 97%;
      outline: none;
      background:none;
      height:30px;
      resize:none;
      overflow-y:hidden;
    }

    .commentImg{
      width: 9%; 
    }

    .commentText{
      width: 91%;
    }

    .commentBtn{
      font-size: 14px;
      font-family: 'Nanum Gothic';
      width:60px;
      height:35px;
      border:none; 
      background-color: gray;
      color:#fff;
      outline:none;
      cursor: pointer;
    }
  }
</style>
<script>
// 댓글입력창 기능
// 댓글 수정시 글에 맞게 높이 조정
$(document).ready(function() {

  $('.commentBox').on( 'change keydown paste cut delete', 'textarea', function (e){
    $(this).css('height', 'auto' ); 
    $(this).height( this.scrollHeight );
  });

  // focus 시 버튼 파란색으로
  $('.commentBox').find('textarea').on('focus', function(e){
    $('#commentBtn').css("background-color", "#005CCF");
  });
  // blur시 높이 30px로
  $('.commentBox').on( 'blur', 'textarea', function (e){
    $(this).height('30px');
    $('#commentBtn').css("background-color", "gray");
  });

  $('.commentBox').find( 'textarea' ).keyup();

  //댓글 수정 입력창 구현
  $('.commentEditBox').on( 'change keydown paste cut delete', 'textarea', function (e){
    $(this).css('height', 'auto' ); 
    $(this).height( this.scrollHeight );
  });

  // focus 시 버튼 파란색으로
  $('.commentEditBox').on( 'focus', 'textarea', function (e){
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.commentEditBtn').css("background-color", "#005CCF");
  });

  // blur시 높이 30px로
  $('.commentEditBox').on( 'blur', 'textarea', function (e){
    $(this).height('30px');
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.commentEditBtn').css("background-color", "gray");
  });

  $('.commentEditBox').find( 'textarea' ).keyup();

    //답글 입력창 구현
    $('.replyBox').on( 'change keydown paste cut delete', 'textarea', function (e){
    $(this).css('height', 'auto' ); 
    $(this).height( this.scrollHeight );
  });

  // focus 시 버튼 파란색으로
  $('.replyBox').on( 'focus', 'textarea', function (e){
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.replyBtn').css("background-color", "#005CCF");
  });

  // blur시 높이 30px로
  $('.replyBox').on( 'blur', 'textarea', function (e){
    $(this).height('30px');
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.replyBtn').css("background-color", "gray");
  });

  $('.replyBox').find( 'textarea' ).keyup();


  //답글 수정창 구현
  $('.replyEditBox').on( 'change keydown paste cut delete', 'textarea', function (e){
    $(this).css('height', 'auto' ); 
    $(this).height( this.scrollHeight );
  });

  // focus 시 버튼 파란색으로
  $('.replyEditBox').on( 'focus', 'textarea', function (e){
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.replyEditBtn').css("background-color", "#005CCF");
  });

  // blur시 높이 30px로
  $('.replyEditBox').on( 'blur', 'textarea', function (e){
    $(this).height('30px');
    $(this).parent().parent().parent().parent().children().children('.commentBtnWrapper').children('.replyBtn').css("background-color", "gray");
  });

  $('.replyEditBox').find( 'textarea' ).keyup();

  // 자세히보기
  $('.commentDetailView').click(function(){
    $(this).parent().parent().addClass('detailedText');
  });
});

function formCheck(frm){
  if (frm.content.value == ''){
    alert("내용을 입력해주세요.");
    frm.content.focus();
    return false;
  }
};
</script>

<!--댓글 영역-->
<div class="commentDesign">
    <!--댓글 등록하기-->
    <h5 style="font-family: 'Nanum Gothic'; padding:1rem; border-bottom: 1px solid gray;
    margin-bottom: 1rem;"><b>댓글 {{teamMatching.total_comment}}개</b></h5>
    {% if errormessage %}
    <script>
      alert("{{errormessage}}");
    </script>
    {% endif %}
    <form method="post" action="{% url 'tmcomment_write' %}" enctype="multipart/form-data" onsubmit="return formCheck(this);">
    {% csrf_token %}
      <div class="commentBox">
        <div class="commentImg">
          <img style= "border-radius: 70px;" width="35px" height="35px" src="{{ fnsuser.userimg.url }}">
          <input type="hidden" name="teamMatching_id" value="{{ teamMatching.id }}">
        </div>
        <div class="commentText">
          <textarea id= "cmContent" name="content" placeholder="댓글을 입력하세요"></textarea>
        </div>
      </div>
      <div class="commentBtnWrapper">
        <button type="reset" style="margin-right: 5px; background-color: white; color: black;" class="commentBtn">취소</button>
        <button type="submit" class="commentBtn" id="commentBtn">댓글</button>
      </div>
    </form>
    <hr style="margin-top:0;">
  
    {% for comment in commentList %}
    <!-- 댓글 답글 전체 래핑 -->
    <div class="commentWrapper" style="max-width: 720px; margin:0 auto; padding:0;">
  
      <!-- 댓글 래퍼(댓글 상세 + 수정폼) -->
      <div class="wrapper">
        <!-- 상세 댓글 -->
        <div class="detail">
          <div class="commentImg">
            <a href="{% url 'myPage' comment.user.id %}">
              <img style="border-radius: 70px; margin-left: 5px;" 
              width="35px" height="35px" src="{{ comment.user.userimg.url }}">
            </a>
          </div>
          <div class="comment">
            <h6>
              <strong class="commentName">{{ comment.user }}</strong> 
              <span class="commentTime">| {{comment.passedTime}}</span>
            </h6>
            {% if comment.content|length > 150 %}
            <div>
              <div class="summary">
                <h5 class="commentContent">{{ comment.summary }}</h5>
                <a type="button" class="commentDetailView">
                  <strong style="font-size: 13px; font-family: 'Nanum Gothic';">...자세히 보기</strong>
                </a>
              </div>
              <h5 class="commentContent commentDetail">{{ comment.content }}</h5>
            </div>
            {% else %}
            <h5 class="commentContent">{{ comment.content }}</h5>
            {% endif %}
            {% if comment.reply.all.count == 0 %}
            <h5 type="button" class="reply commentContent" style = "color: cornflowerblue; font-weight: bold;">답글 달기</h5>
            {% else %}
            <h5 type="button" class="reply commentContent" style = "color: cornflowerblue; font-weight: bold;">답글 {{comment.reply.all.count}}개</h5>
            {% endif %}
            <h5 type="button" class="allReplyCancel commentContent" style = "color: cornflowerblue; font-weight: bold;" type="button">답글 닫기</h5>
          </div>
          {% if comment.user == fnsuser %}
          <div class="commentDropDown">
            <button type="button" class="commentDropBtn"> 
            <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="cmDropDownContent" style="z-index: 100;">
              <button class="dropdown-item edit" type="button">수정</button>
              <button class="dropdown-item" type="button" id="deletePC">
                <a href ="{% url 'deleteTC' comment.id%}" onclick="return deletePC()"
                style="text-align: center; padding-top:5px; padding-bottom: 5px; background:none;">
                  삭제
                </a>
              </button>
            </div>
            <!-- cmDropDownContent -->
          </div>
          <!-- commentDropDown -->
          {% endif %}
        </div>
        <!-- 상세 댓글 끝 -->
  
        <!-- 댓글 수정 폼 -->
        <div class="editForm" style="max-width: 720px;">
          <form method="post" action="{% url 'editTC' comment.id %}" enctype="multipart/form-data" id="2" onsubmit="return formCheck(this);">
            {% csrf_token %}
            <div class="commentEditBox">
              <div class="commentImg">
                <img style= "border-radius: 70px;" width="35px" height="35px" src="{{ fnsuser.userimg.url }}">
                <input type="hidden" name="teamMatching_id" value="{{ teamMatching.id }}">
              </div>
              <div class="commentText">
                <textarea name="content" placeholder="댓글을 수정하세요"></textarea>
              </div>
            </div>
            <div class="commentBtnWrapper">
              <button type="reset" style="margin-right: 5px; background-color: white; color: black;" class="commentBtn cancel">취소</button>
              <button type="submit" class="commentBtn commentEditBtn">수정</button>
            </div>
          </form>
        </div>
        <!-- 댓글수정폼 끝 -->
        <hr style="margin-top:0.5rem;">
      </div>
      <!-- 댓글래퍼 끝 -->
      <!-- 답글 -->
      <div class="replyAll" id="test1">
        <form method="post" action="{% url 'teamReply_write' %}" enctype="multipart/form-data" onsubmit="return formCheck(this);">
        {% csrf_token %}
          <!-- 답글쓰기 -->
          <div class="replyBox">
            <div class="commentImg">
              <img style="border-radius: 70px;" width="30px" height="30px" src="{{ fnsuser.userimg.url }}">
              <input type="hidden" name="teamMatching_id" value="{{ teamMatching.id }}">
              <input type="hidden" name="comment_id" value="{{ comment.id }}">
            </div>
            <div class="commentText">
              <textarea name="content" placeholder="답글을 입력하세요"></textarea>   
            </div>
          </div>
          <div class="commentBtnWrapper">
            <button type="reset" style="margin-right: 5px; background-color: white; color: black;" class="commentBtn">취소</button>    
            <button type="submit" class="commentBtn replyBtn">등록</button>
          </div>
        </form>
        <hr style="margin-top: 0;">
  
  
        <!-- 답글 목록 -->
        {% for reply in comment.reply.all %}
          
        <div class="replyWrapper" id = replyWrapper>
        <!-- replyDetail -->
          <div class="replyDetail">
            <div class="commentImg">
                <a href="{% url 'myPage' reply.user.id %}">
                  <img style="border-radius: 70px;" width="30px" height="30px" src="{{ reply.user.userimg.url }}">
                </a>
            </div>
            <div class="comment">
              <h6>
                <strong class="commentName">{{ reply.user }}</strong> 
                <span class="commentTime">| {{reply.passedTime}}</span>
              </h6>
              {% if reply.content|length > 150 %}
              <div>
                <div class="summary">
                  <h6 class="commentContent">{{ reply.summary }}</h6>
                  <a type="button" class="commentDetailView">
                    <strong style="font-size: 13px; font-family: 'Nanum Gothic';">...자세히 보기</strong>
                  </a>
                </div>
                <h6 class="commentContent commentDetail">{{ reply.content }}</h6>
              </div>
              {% else %}
              <h6 class="commentContent">{{ reply.content }}</h6>
              {% endif %}
            </div>
            {% if reply.user == fnsuser %}
            <div class="commentDropDown">
              <button type="button" class="commentDropBtn"> 
              <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="cmDropDownContent" style="z-index: 100;">
                <button class="dropdown-item replyEdit" type="button">수정</button>
                <button class="dropdown-item" type="button" id="deletePC">
                  <a href ="{% url 'deleteTeamReply' reply.id%}" onclick="return deletePC()"
                  style="text-align: center; padding-top:5px; padding-bottom: 5px; background:none;">
                    삭제
                  </a>
                </button>
              </div>
              <!-- cmDropDownContent -->
            </div>
            <!-- commentDropDown -->
            {% endif %}
          </div>
          <!-- replyDetail 끝 -->
          
           <!-- replyEditForm -->
          <div class="replyEditForm">
            <form method="post" action="{% url 'editTeamReply' reply.id %}" enctype="multipart/form-data" onsubmit="return formCheck(this);">
            {% csrf_token %}
              <div class="replyEditBox">
                <div class="commentImg">
                  <img style="border-radius: 70px;" width="30px" height="30px" src="{{ reply.user.userimg.url }}">
                  <input type="hidden" name="teamMatching_id" value="{{ teamMatching.id }}">
                </div>
                <div class="commentText replyEditText">
                  <textarea name="content" placeholder="답글을 수정하세요"></textarea>  
                </div>
              </div>
              <div class="commentBtnWrapper">
                <button type="reset" style="margin-right: 5px; background-color: white; color: black;" class="commentBtn replyCancel">취소</button>
                <button type="submit" class="commentBtn replyEditBtn">수정</button>
              </div> 
            </form>
          </div>
          <!-- replyEditForm 끝 -->
          
        </div>
        <!-- ReplyWrapper 끝 -->
        <hr>
        {% endfor %}
        {% if comment.reply.all.count > 4 %}
          <h5 style="background-color: cornflowerblue; margin:0; text-align: center; 
          font-size:14px; font-family:'Nanum Gothic'; padding-top: 5px; padding-bottom: 5px;
          color: white; font-weight: bold;">답글 끝</h5>
          <hr style="margin-top: 0;">
        {% endif %}
      </div>
      <!-- 답글 끝 -->
  
    </div>
    <!-- 댓글 답글 끝 -->
    {% endfor %}
      <!-- 댓글 페이지네이션 -->
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      {% if commentList.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1" tabindex="-1" aria-disabled="true">처음으로</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{commentList.previous_page_number}}" tabindex="-1" aria-disabled="true">{{commentList.previous_page_number}}</a>
      </li>
      {% endif %}
      
      <li class="page-item disabled"><a class="page-link" href="#">{{commentList.number}}</a></li>
      {% if commentList.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{commentList.next_page_number}}">{{commentList.next_page_number}}</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{commentList.paginator.num_pages}}">마지막으로</a>
      </li>
      {% endif %}
    </ul>
  </nav>
    <!-- 댓글 페이지네이션 끝 -->
  
  </div>
  <!-- commentDesign 끝 -->
  <!--댓글 영역 끝-->
  
  
  
  
  <script type="text/javascript">
    // 댓글 수정버튼
    $('.edit').click(function(){
      $(this).parent().parent().parent().parent().addClass("editToggle");
    });
    // 수정버튼 후 취소
    $('.cancel').click(function(){
      $(this).parent().parent().parent().parent().removeClass("editToggle");
    });
    // 답글버튼
    $('.reply').click(function(){
      $(this).parent().parent().parent().parent().children('.replyAll').addClass("replyToggle");
      $(this).parent().addClass("replyButton");
      // var id = $(this).parent().parent().parent().parent().parent().children('.replyAll').children('.replyWrapper').attr('id');
      // alert(id);
    })
    // 답글버튼 후 답글닫기
    $('.allReplyCancel').click(function(){
      $(this).parent().parent().parent().parent().children('.replyAll').removeClass("replyToggle");
      $(this).parent().removeClass("replyButton");
    });
    // 답글수정
    $('.replyEdit').click(function(){
      $(this).parent().parent().parent().parent().addClass("replyEditToggle");
    })
    // 답글수정취소
    $('.replyCancel').click(function(){
      $(this).parent().parent().parent().parent().removeClass("replyEditToggle");
    })
  
    </script>